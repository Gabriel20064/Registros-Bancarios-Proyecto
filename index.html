<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>HyperLinkBlocked</title>
</head>
<body>
    <h2 class="titleProyecto">Registros Bancarios</h2>
    
    <section id="transacciones">
        <h3>Transacciones</h3>

        <div style="text-align: right;">
            <button id="transacciones_btAdd" style="font-size: 1rem">Agregar transaccion</button> <br><br>
        </div>

        <div style="margin-bottom: 10px;">
            <table>
                <thead>
                    <tr>
                    <th style="width: 150px;">Fecha</th>
                    <th style="width: 200px;">Descripcion</th>
                    <th style="width: 80px;">Tipo de Transaccion</th>
                    <th style="width: 160px;">Monto</th>
                    <th style="width: 100px;">Referencia</th>
                    <th style="width: 120px;">Categoria</th>
                    <th style="width: 150px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="transacciones_divTransacciones"></tbody>
            </table>
        </div>
            <section id="transacciones">
        <h3>Resultados de la Conciliacion</h3>
        <div>
            <h4 id="totalDeAbonos">Total de abonos: </h4>
            <h5 id="totalDeCargos">Total de cargos: </h5>
            <h1 id="saldoFinal">Saldos finales: </h1>
        </div>
    </section>
    </section>

    <section id="registroTransaccion" hidden>
        <h3>Nueva Transaccion</h3> 

            <label>Tipo de Transaccion:</label>
                <select id="registroTransaccion_inTipoTransaccion">
                    <option value= 1 >Cargo</option>
                    <option value= 2 >Abono</option>
                </select><br>

            <label>Fecha: </label>
                <input id= "registroTransaccion_inFecha" type="date" name="fecha" required><br>

            <label>Descripcion:</label>
                <input id= "registroTransaccion_inDescripcion" type="text" name="descripcion" minlength="1" maxlength="30" required placeholder="Ej. Pago de servicios"><br>

            <label>Referencia:</label>
                <input id="registroTransaccion_inReferencia" type="text" name="referencia" minlength="1" maxlength="3" required placeholder="Ej.001"><br>

            <label>Categoria:</label>
                <select id= "registroTransaccion_inCategoria" type="text" name="categoria" required>
                    <option value= 1 >Ingreso</option>
                    <option value= 2 >Alimentación</option>
                    <option value= 3 >Servicios Basicos</option>
                    <option value= 4 >Artículos de Vestimenta</option>
                    <option value= 5 >Servicios Publicos</option>
                    <option value= 6 >Entretenimiento</option>
                    <option value= 7 >Educación</option>
                    <option value= 8 >Gasto del Hogar</option>
                    <option value= 9 >Otros</option>
                </select><br>

            <label>Monto:</label>
            <input id="registroTransaccion_inMonto" type="number" min= "0" maxlength="7" name="monto" step="0.01" required>
            <br><br>
        <button id="registroTransaccion_btGuardar">Guardar</button>
        <button id="registroTransaccion_btVolver">Volver</button>
    </section>

    <section id="editTransaccion" hidden>
        <h3>Editar Transaccion</h3>
            <input id="editTransaccion_inReferenciaHidden" type="hidden">

            <label>Tipo de Transaccion:</label>
                <select id="editTransaccion_inTipoTransaccion">
                    <option value= 1 >Cargo</option>
                    <option value= 2 >Abono</option>
                </select><br>

            <label>Fecha: </label>
                <input id= "editTransaccion_inFecha" type="date" name="fecha" required><br>

            <label>Descripcion:</label>
                <input id= "editTransaccion_inDescripcion" type="text" name="descripcion" minlength="1" maxlength="30" required placeholder="Ej. Pago de servicios"><br>

            <label>Referencia:</label>
                <input id="editTransaccion_inReferencia" type="text" name="referencia" minlength="1" maxlength="3" required placeholder="Ej.001"><br>

            <label>Categoria:</label>
                <select id= "editTransaccion_inCategoria" type="text" name="categoria" required>
                    <option value= 1 >Ingreso</option>
                    <option value= 2 >Alimentación</option>
                    <option value= 3 >Servicios Basicos</option>
                    <option value= 4 >Artículos de Vestimenta</option>
                    <option value= 5 >Servicios Publicos</option>
                    <option value= 6 >Entretenimiento</option>
                    <option value= 7 >Educación</option>
                    <option value= 8 >Gasto del Hogar</option>
                    <option value= 9 >Otros</option>
                </select><br>
            <label>Monto:</label>
            <input id="editTransaccion_inMonto" type="number" min= "0" maxlength="7" name="monto" step="0.01" required><br><br>

        <button id="editTransaccion_btGuardar">Guardar</button>
        <button id="editTransaccion_btCancelar">Cancelar</button>
    </section>

    
<script>
(function(){ //Metodos de clase grande y actualizacion constante de sus datos.
  const STORAGE_KEY = "Movimientos_Bancarios_data";

  function leerTransacciones() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return [];
    try {
      return JSON.parse(data);
    } catch (e) {
      console.error("Error parseando transacciones desde localStorage", e);
      return [];
    }
  }

  function calcularTotales(transacciones) {
    let totalCargos = 0;
    let totalAbonos = 0;
    for (const t of transacciones) {
      const monto = Number(t.monto) || 0;
      const tipo = Number(t.tipoTransaccion) || 0;
      if (tipo === 1) totalCargos -= monto; // Cargo
      else if (tipo === 2) totalAbonos += monto; // Abono
    }
    return { totalCargos, totalAbonos, saldoFinal: totalAbonos + totalCargos };
  }

  function formatear(n) { return Number(n).toFixed(2); }

  function actualizarDOM() {
    const trans = leerTransacciones();
    const tot = calcularTotales(trans);

    const elCargos = document.getElementById("totalDeCargos");
    const elAbonos = document.getElementById("totalDeAbonos");
    const elSaldo = document.getElementById("saldoFinal");

    if (elCargos) elCargos.textContent = `Total de cargos: Bs. ${formatear(tot.totalCargos)}`;
    if (elAbonos) elAbonos.textContent = `Total de abonos: Bs. ${formatear(tot.totalAbonos)}`;
    if (elSaldo)  elSaldo.textContent  = `Saldos finales: Bs. ${formatear(tot.saldoFinal)}`;
  }

  // Observador para detectar cambios en la tabla de transacciones y actualizar totales
  function observarTabla() {
    const tbody = document.getElementById("transacciones_divTransacciones");
    if (!tbody) return;
    const observer = new MutationObserver(() => {
      // pequeña demora para permitir que Cl_vBanco actualice innerHTML completamente
      setTimeout(actualizarDOM, 0);
    });
    observer.observe(tbody, { childList: true, subtree: true, characterData: true });
  }

  // Inicializar
  document.addEventListener("DOMContentLoaded", () => {
    // actualizar al inicio
    actualizarDOM();
    // observar cambios en la tabla producidos por la app
    observarTabla();
    // fallback: si algo no detecta el cambio, re-evaluar cada 1s (opcional, puedes reducir o quitar)
    setInterval(actualizarDOM, 1000);
  });
})();
</script>




    <script type="module">
        import Cl_index from "./dist/Cl_index.js";
        new Cl_index();
    </script>
</body>
</html>